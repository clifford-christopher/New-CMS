# Story 1.5: AWS Deployment Setup for Staging Environment

## Status

Draft

## Story

**As a** developer,
**I want** the application deployed to AWS EC2 staging environment,
**so that** stakeholders can test the foundation in a production-like setting.

## Acceptance Criteria

1. AWS EC2 instance (t3.medium) provisioned for staging environment
2. MongoDB installed and running on dedicated EC2 instance or MongoDB Atlas configured
3. Python 3.11+ installed with FastAPI backend deployed using virtual environment
4. FastAPI backend runs as systemd service using uvicorn (auto-restart on failure)
5. Next.js frontend build deployed (either static export to S3+CloudFront or running on same EC2 with Node.js)
6. Nginx configured as reverse proxy for SSL termination and routing (frontend, backend API)
7. SSL certificate configured using AWS Certificate Manager (HTTPS enabled)
8. AWS Secrets Manager stores MongoDB credentials and LLM API keys
9. Basic CI/CD pipeline (GitHub Actions) deploys to staging on push to `develop` branch
10. Staging environment accessible via public URL (e.g., https://staging.news-cms.example.com)
11. CloudWatch Logs configured to capture application logs (FastAPI and Next.js)
12. Health check endpoint `/api/health` accessible and returns 200 status

## Tasks / Subtasks

- [ ] Task 1: Provision AWS infrastructure (AC: 1, 2, 8)
  - [ ] Create EC2 t3.medium instance for application server
  - [ ] Configure security groups (allow 80, 443, 22)
  - [ ] Set up MongoDB (Atlas or dedicated EC2)
  - [ ] Configure AWS Secrets Manager for credentials
  - [ ] Create IAM role with Secrets Manager read access
- [ ] Task 2: Install and configure backend (AC: 3, 4)
  - [ ] Install Python 3.11+ on EC2
  - [ ] Clone repository and set up virtual environment
  - [ ] Install backend dependencies
  - [ ] Create systemd service for uvicorn
  - [ ] Configure environment variables from Secrets Manager
- [ ] Task 3: Deploy frontend (AC: 5)
  - [ ] Decide: static export to S3+CloudFront OR SSR on EC2
  - [ ] Install Node.js 18.x if running on EC2
  - [ ] Build and deploy frontend
  - [ ] Configure frontend to point to backend API
- [ ] Task 4: Configure Nginx and SSL (AC: 6, 7)
  - [ ] Install Nginx on EC2
  - [ ] Configure reverse proxy routes
  - [ ] Set up SSL certificate with AWS Certificate Manager
  - [ ] Configure HTTPS redirects
- [ ] Task 5: Set up CloudWatch Logs (AC: 11)
  - [ ] Install CloudWatch agent
  - [ ] Configure log groups for backend and frontend
  - [ ] Set up log streaming
- [ ] Task 6: Create CI/CD pipeline (AC: 9)
  - [ ] Create GitHub Actions workflow
  - [ ] Configure deployment to staging on develop branch
  - [ ] Set up deployment secrets in GitHub
- [ ] Task 7: Verify deployment (AC: 10, 12)
  - [ ] Test public URL access
  - [ ] Verify health check endpoint
  - [ ] Test full application workflow
  - [ ] Document deployment process

## Dev Notes

### Prerequisites from Previous Stories

[Source: Story 1.1-1.4 - Completion]

Before starting this story, ensure the following are complete:
- **Story 1.1**: Monorepo with backend and frontend working locally
- **Story 1.2**: MongoDB models and connection established
- **Story 1.3**: UI shell with navigation components
- **Story 1.4**: Trigger management API and dashboard functional

### AWS Infrastructure Overview

[Source: architecture.md - Development and Deployment - Build and Deployment Process]

**Deployment Architecture** (No Containerization):
```
[User Browser]
     ↓ HTTPS (443)
[CloudFront or ALB - SSL Termination]
     ↓
[EC2 Instance - t3.medium]
  ├── Nginx (Reverse Proxy)
  │    ├── /api → localhost:8000 (FastAPI backend)
  │    └── /    → localhost:3000 (Next.js frontend OR static files)
  ├── FastAPI (uvicorn) - systemd service
  └── Next.js (if SSR) OR S3+CloudFront (if static export)
     ↓
[MongoDB - Dedicated EC2 OR MongoDB Atlas]
```

### AWS Resources Required

[Source: architecture.md - Development and Deployment - AWS Infrastructure Requirements]

**Resources to provision**:
- **EC2 Instance**: t3.medium for staging (2 vCPUs, 4GB RAM)
- **MongoDB**: Choose one:
  - Option A: Dedicated EC2 instance with MongoDB Community Edition
  - Option B: MongoDB Atlas free tier or paid cluster
- **S3 Bucket**: For logs, backups, static assets (if using static export)
- **CloudWatch Logs**: Application logs for backend and frontend
- **AWS Secrets Manager** secrets:
  - `news-cms/llm/openai/api-key`
  - `news-cms/llm/anthropic/api-key`
  - `news-cms/llm/google/api-key`
  - `news-cms/db/mongodb-uri`
- **IAM Role**: EC2 instance role with Secrets Manager read access
- **SSL Certificate**: AWS Certificate Manager for HTTPS
- **Security Groups**:
  - Allow inbound: 80 (HTTP), 443 (HTTPS), 22 (SSH from specific IPs)
  - Internal only: 8000 (FastAPI), 3000 (Next.js if SSR), 27017 (MongoDB)

### EC2 Instance Setup

[Source: architecture.md - Development and Deployment - Manual Deployment]

**Step 1: Launch EC2 Instance**

```bash
# AWS CLI command to launch instance
aws ec2 run-instances \
  --image-id ami-0c55b159cbfafe1f0 \  # Amazon Linux 2 or Ubuntu 22.04
  --instance-type t3.medium \
  --key-name news-cms-staging-key \
  --security-group-ids sg-xxxxx \
  --iam-instance-profile Name=news-cms-ec2-role \
  --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=news-cms-staging}]'
```

**Step 2: Connect to Instance**

```bash
ssh -i "news-cms-staging-key.pem" ec2-user@<public-ip>
```

**Step 3: Install System Dependencies**

```bash
# Update system
sudo yum update -y  # Amazon Linux 2
# OR
sudo apt update && sudo apt upgrade -y  # Ubuntu

# Install Python 3.11+
sudo yum install python3.11 -y
# OR
sudo apt install python3.11 python3.11-venv -y

# Install Node.js 18.x (if running SSR frontend)
curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
sudo yum install nodejs -y
# OR
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install nodejs -y

# Install Git
sudo yum install git -y
# OR
sudo apt install git -y

# Install Nginx
sudo yum install nginx -y
# OR
sudo apt install nginx -y
```

### Backend Deployment

[Source: architecture.md - Development and Deployment - Manual Deployment]

**File: /home/ec2-user/deploy-backend.sh**

```bash
#!/bin/bash

# Clone repository
cd /var/www
sudo mkdir -p news-cms
sudo chown ec2-user:ec2-user news-cms
cd news-cms
git clone <repository-url> .
git checkout develop

# Backend setup
cd backend
python3.11 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt

# Fetch secrets from AWS Secrets Manager
export MONGODB_URI=$(aws secretsmanager get-secret-value --secret-id news-cms/db/mongodb-uri --query SecretString --output text)
export OPENAI_API_KEY=$(aws secretsmanager get-secret-value --secret-id news-cms/llm/openai/api-key --query SecretString --output text)
export ANTHROPIC_API_KEY=$(aws secretsmanager get-secret-value --secret-id news-cms/llm/anthropic/api-key --query SecretString --output text)
export GOOGLE_API_KEY=$(aws secretsmanager get-secret-value --secret-id news-cms/llm/google/api-key --query SecretString --output text)

# Create .env file
cat > .env << EOF
MONGODB_URI=${MONGODB_URI}
OPENAI_API_KEY=${OPENAI_API_KEY}
ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
GOOGLE_API_KEY=${GOOGLE_API_KEY}
AWS_REGION=us-east-1
DEBUG=false
EOF

echo "Backend deployment complete"
```

### Systemd Service Configuration

[Source: architecture.md - Development and Deployment - Manual Deployment]

**File: /etc/systemd/system/news-cms-backend.service**

```ini
[Unit]
Description=News CMS FastAPI Backend
After=network.target

[Service]
Type=simple
User=ec2-user
WorkingDirectory=/var/www/news-cms/backend
Environment="PATH=/var/www/news-cms/backend/venv/bin"
EnvironmentFile=/var/www/news-cms/backend/.env
ExecStart=/var/www/news-cms/backend/venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 2
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**Enable and start service**:

```bash
sudo systemctl daemon-reload
sudo systemctl enable news-cms-backend
sudo systemctl start news-cms-backend
sudo systemctl status news-cms-backend
```

### Frontend Deployment Options

[Source: architecture.md - Development and Deployment - Build and Deployment Process]

**Option A: Static Export to S3 + CloudFront** (Recommended for MVP)

```bash
# Build static export
cd /var/www/news-cms/frontend
npm install
npm run build
# Next.js output: frontend/out/

# Upload to S3
aws s3 sync out/ s3://news-cms-staging-frontend/ --delete

# CloudFront invalidation
aws cloudfront create-invalidation --distribution-id E123456789 --paths "/*"
```

**Option B: SSR on EC2 with systemd**

```bash
# Build Next.js app
cd /var/www/news-cms/frontend
npm install
npm run build

# Create systemd service
sudo cat > /etc/systemd/system/news-cms-frontend.service << EOF
[Unit]
Description=News CMS Next.js Frontend
After=network.target

[Service]
Type=simple
User=ec2-user
WorkingDirectory=/var/www/news-cms/frontend
Environment="PATH=/usr/bin:/usr/local/bin"
Environment="NODE_ENV=production"
Environment="PORT=3000"
ExecStart=/usr/bin/npm start
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable news-cms-frontend
sudo systemctl start news-cms-frontend
```

### Nginx Configuration

[Source: architecture.md - Development and Deployment - Manual Deployment]

**File: /etc/nginx/conf.d/news-cms.conf**

```nginx
# Redirect HTTP to HTTPS
server {
    listen 80;
    server_name staging.news-cms.example.com;
    return 301 https://$server_name$request_uri;
}

# Main HTTPS server
server {
    listen 443 ssl http2;
    server_name staging.news-cms.example.com;

    # SSL certificates from AWS Certificate Manager (via ALB)
    # OR Let's Encrypt if direct EC2
    ssl_certificate /etc/ssl/certs/news-cms.crt;
    ssl_certificate_key /etc/ssl/private/news-cms.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # Logs
    access_log /var/log/nginx/news-cms-access.log;
    error_log /var/log/nginx/news-cms-error.log;

    # Backend API proxy
    location /api {
        proxy_pass http://localhost:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # Frontend (Option B: SSR on EC2)
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # Frontend (Option A: Static files from S3+CloudFront)
    # Location / would be handled by CloudFront distribution
}
```

**Enable and restart Nginx**:

```bash
sudo nginx -t  # Test configuration
sudo systemctl restart nginx
sudo systemctl enable nginx
```

### CloudWatch Logs Configuration

[Source: architecture.md - Development and Deployment - Logging & Monitoring]

**Install CloudWatch Agent**:

```bash
wget https://s3.amazonaws.com/amazoncloudwatch-agent/amazon_linux/amd64/latest/amazon-cloudwatch-agent.rpm
sudo rpm -U ./amazon-cloudwatch-agent.rpm
```

**File: /opt/aws/amazon-cloudwatch-agent/etc/config.json**

```json
{
  "logs": {
    "logs_collected": {
      "files": {
        "collect_list": [
          {
            "file_path": "/var/www/news-cms/backend/logs/app.log",
            "log_group_name": "/aws/news-cms/staging/backend",
            "log_stream_name": "{instance_id}-backend",
            "timezone": "UTC"
          },
          {
            "file_path": "/var/log/nginx/news-cms-access.log",
            "log_group_name": "/aws/news-cms/staging/nginx-access",
            "log_stream_name": "{instance_id}",
            "timezone": "UTC"
          },
          {
            "file_path": "/var/log/nginx/news-cms-error.log",
            "log_group_name": "/aws/news-cms/staging/nginx-error",
            "log_stream_name": "{instance_id}",
            "timezone": "UTC"
          }
        ]
      }
    }
  }
}
```

**Start CloudWatch Agent**:

```bash
sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \
  -a fetch-config \
  -m ec2 \
  -s \
  -c file:/opt/aws/amazon-cloudwatch-agent/etc/config.json
```

### CI/CD Pipeline with GitHub Actions

[Source: architecture.md - Development and Deployment - CI/CD Pipeline]

**File: .github/workflows/deploy-staging.yml**

```yaml
name: Deploy to Staging

on:
  push:
    branches:
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Deploy backend to EC2
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > private_key.pem
          chmod 600 private_key.pem

          # SSH to EC2 and pull latest code
          ssh -i private_key.pem -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
            cd /var/www/news-cms
            git pull origin develop
            cd backend
            source venv/bin/activate
            pip install -r requirements.txt
            sudo systemctl restart news-cms-backend
          EOF

      - name: Build and deploy frontend
        run: |
          # Option A: Deploy to S3+CloudFront
          cd frontend
          npm install
          npm run build
          aws s3 sync out/ s3://news-cms-staging-frontend/ --delete
          aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"

          # Option B: Deploy to EC2
          # ssh -i private_key.pem ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
          #   cd /var/www/news-cms/frontend
          #   npm install
          #   npm run build
          #   sudo systemctl restart news-cms-frontend
          # EOF

      - name: Verify deployment
        run: |
          # Wait for services to restart
          sleep 10

          # Check health endpoint
          curl -f https://staging.news-cms.example.com/api/health || exit 1

          echo "Deployment successful!"

      - name: Cleanup
        if: always()
        run: rm -f private_key.pem
```

**Required GitHub Secrets**:
- `AWS_ACCESS_KEY_ID`
- `AWS_SECRET_ACCESS_KEY`
- `EC2_SSH_KEY` (private key for SSH access)
- `EC2_HOST` (public IP or domain)
- `CLOUDFRONT_DISTRIBUTION_ID` (if using Option A)

### MongoDB Setup Options

[Source: architecture.md - Integration Points and External Dependencies]

**Option A: MongoDB Atlas** (Recommended for staging)

1. Create free tier cluster at https://www.mongodb.com/cloud/atlas
2. Configure IP whitelist to allow EC2 instance
3. Get connection string: `mongodb+srv://user:pass@cluster.mongodb.net/news_cms_staging`
4. Store in AWS Secrets Manager: `news-cms/db/mongodb-uri`

**Option B: Dedicated MongoDB EC2**

```bash
# Launch separate EC2 instance
# Install MongoDB Community Edition
wget -qO - https://www.mongodb.org/static/pgp/server-5.0.asc | sudo apt-key add -
echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/5.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-5.0.list
sudo apt update
sudo apt install -y mongodb-org

# Configure MongoDB
sudo systemctl start mongod
sudo systemctl enable mongod

# Create database and user
mongo
> use news_cms_staging
> db.createUser({user: "newscms", pwd: "SecurePassword123", roles: ["readWrite"]})

# Connection string
MONGODB_URI=mongodb://newscms:SecurePassword123@<mongodb-ec2-private-ip>:27017/news_cms_staging
```

### Environment Variables

[Source: architecture.md - Development and Deployment - Environment Variables]

**Staging Environment Variables** (stored in AWS Secrets Manager):

```bash
# MongoDB
MONGODB_URI=<from Secrets Manager>

# LLM API Keys
OPENAI_API_KEY=<from Secrets Manager>
ANTHROPIC_API_KEY=<from Secrets Manager>
GOOGLE_API_KEY=<from Secrets Manager>

# AWS
AWS_REGION=us-east-1
AWS_SECRETS_MANAGER_PREFIX=news-cms/

# Application
DEBUG=false
ENVIRONMENT=staging
```

### Security Configuration

[Source: architecture.md - Technical Assumptions - Security & Authentication]

**Security Group Rules**:

```bash
# Inbound rules
Port 80 (HTTP) - Source: 0.0.0.0/0
Port 443 (HTTPS) - Source: 0.0.0.0/0
Port 22 (SSH) - Source: <your-office-ip>/32

# Internal only (not exposed)
Port 8000 (FastAPI) - Internal
Port 3000 (Next.js) - Internal
Port 27017 (MongoDB) - Internal or MongoDB EC2 only
```

**IAM Role Policy** (news-cms-ec2-role):

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue",
        "secretsmanager:DescribeSecret"
      ],
      "Resource": "arn:aws:secretsmanager:us-east-1:*:secret:news-cms/*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:PutLogEvents",
        "logs:DescribeLogStreams"
      ],
      "Resource": "arn:aws:logs:us-east-1:*:log-group:/aws/news-cms/*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:GetObject",
        "s3:DeleteObject"
      ],
      "Resource": "arn:aws:s3:::news-cms-staging-frontend/*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "cloudfront:CreateInvalidation"
      ],
      "Resource": "*"
    }
  ]
}
```

### Testing

[Source: PRD - Technical Assumptions - Testing Requirements]

**Testing Strategy for Story 1.5**:

**Deployment Verification Tests**:

```bash
# Test 1: Health check endpoint
curl -f https://staging.news-cms.example.com/api/health
# Expected: {"status": "ok", "database": "connected", "timestamp": "..."}

# Test 2: Backend API documentation
curl https://staging.news-cms.example.com/api/docs
# Expected: Swagger UI HTML

# Test 3: Frontend accessible
curl -f https://staging.news-cms.example.com/
# Expected: 200 status, Next.js HTML

# Test 4: SSL certificate valid
openssl s_client -connect staging.news-cms.example.com:443 -servername staging.news-cms.example.com
# Expected: Valid certificate chain

# Test 5: Backend service running
ssh ec2-user@<host> "sudo systemctl status news-cms-backend"
# Expected: active (running)

# Test 6: Nginx running
ssh ec2-user@<host> "sudo systemctl status nginx"
# Expected: active (running)

# Test 7: CloudWatch logs streaming
aws logs tail /aws/news-cms/staging/backend --follow --since 5m
# Expected: Recent log entries

# Test 8: Secrets Manager access
ssh ec2-user@<host> "aws secretsmanager get-secret-value --secret-id news-cms/db/mongodb-uri --query SecretString --output text"
# Expected: MongoDB connection string (not error)
```

**Integration Tests**:

```python
# backend/tests/integration/test_staging_deployment.py
import pytest
import requests
import os

STAGING_URL = os.getenv("STAGING_URL", "https://staging.news-cms.example.com")

def test_health_endpoint_accessible():
    """Test health check endpoint on staging"""
    response = requests.get(f"{STAGING_URL}/api/health")
    assert response.status_code == 200
    data = response.json()
    assert data["status"] == "ok"
    assert data["database"] == "connected"

def test_triggers_endpoint_accessible():
    """Test triggers API on staging"""
    response = requests.get(f"{STAGING_URL}/api/triggers")
    assert response.status_code == 200
    data = response.json()
    assert isinstance(data, list)

def test_frontend_accessible():
    """Test frontend loads on staging"""
    response = requests.get(STAGING_URL)
    assert response.status_code == 200
    assert "AI News CMS" in response.text or "News CMS" in response.text

def test_ssl_certificate_valid():
    """Test HTTPS is properly configured"""
    response = requests.get(STAGING_URL)
    assert response.url.startswith("https://")
    # Requests library verifies SSL by default; no exception = valid cert

def test_api_documentation_accessible():
    """Test FastAPI docs accessible"""
    response = requests.get(f"{STAGING_URL}/api/docs")
    assert response.status_code == 200
    assert "swagger" in response.text.lower() or "openapi" in response.text.lower()
```

**Manual Verification Checklist**:
1. EC2 instance running and accessible via SSH
2. MongoDB connection successful from EC2
3. Backend service running: `sudo systemctl status news-cms-backend`
4. Frontend deployed and accessible
5. Nginx reverse proxy working
6. HTTPS enabled with valid SSL certificate
7. Health check endpoint: https://staging.news-cms.example.com/api/health returns 200
8. API docs accessible: https://staging.news-cms.example.com/api/docs
9. Frontend accessible: https://staging.news-cms.example.com/
10. CloudWatch logs capturing application logs
11. GitHub Actions workflow runs successfully on push to develop
12. Secrets Manager stores all required secrets
13. IAM role permissions working (no permission errors in logs)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-29 | 1.0 | Initial story created from Epic 1 | Sarah (PO) |
| 2025-10-29 | 1.1 | Enriched with full architectural context and testing standards | Bob (SM) |

## Dev Agent Record

*To be populated during implementation*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes List

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*To be filled by QA agent*
