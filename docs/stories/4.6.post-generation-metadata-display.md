# Story 4.6: Post-Generation Metadata Display

## Status

Complete

## Story

**As a** content manager,
**I want** to see actual token usage, generation time, and cost for each model after generation completes,
**so that** I can make informed decisions about model selection based on performance and cost efficiency.

## Acceptance Criteria

1. After generation completes, metadata displayed below each model result card (AC: 1)
2. Metadata shows three key metrics with icons: (AC: 2)
   - üéØ Tokens Used: Actual token count returned by LLM API
   - ‚è±Ô∏è Time Taken: Generation time in seconds (e.g., 8.3s)
   - üí∞ Actual Cost: Calculated cost based on actual tokens used (e.g., $0.08)
3. Metadata container has subtle background color (#f8f9fa) to distinguish from estimate (AC: 3)
4. Label "GENERATION METRICS" or "‚ö° ACTUAL METRICS" indicates post-generation data (AC: 4)
5. Cost updates from estimated (shown before generation) to actual (shown after) (AC: 5)
6. Visual comparison available: estimated cost vs. actual cost shown side-by-side or with diff indicator (AC: 6)
7. Meets FR40: displays actual token usage, generation time, and cost per model per prompt type (AC: 7)
8. Metadata persists in session and displayed when viewing historical generations (AC: 8)
9. Total cost summary shown at bottom: "Total actual cost: $0.48 (6 generations)" (AC: 9)
10. Export or copy functionality includes metadata for reporting purposes (AC: 10)
11. Metadata tooltip provides breakdown: "Prompt tokens: 234, Completion tokens: 222, Total: 456" (AC: 11)
12. Performance indicators: green (fast/<5s), yellow (medium 5-15s), red (slow/>15s) for time taken (AC: 12)

## Tasks / Subtasks

- [ ] Task 1: Create MetadataDisplay component for result card (AC: 1, 2, 3, 4, 11, 12)
  - [ ] Create frontend/src/components/config/MetadataDisplay.tsx
  - [ ] Display actual metrics: tokens, latency, cost
  - [ ] Render with icons: üéØ, ‚è±Ô∏è, üí∞
  - [ ] Gray background (#f8f9fa) styling
  - [ ] Performance color indicators (green/yellow/red for latency)
  - [ ] Tooltip breakdown for token counts
  - [ ] Show "‚ö° ACTUAL METRICS" label
- [ ] Task 2: Implement cost comparison display (AC: 5, 6)
  - [ ] Calculate estimated cost based on model pricing and estimated tokens
  - [ ] Store estimated cost before generation
  - [ ] Display side-by-side: estimated vs. actual cost
  - [ ] Highlight cost difference/variance
  - [ ] Create CostComparison sub-component
  - [ ] Show percentage variance from estimate
- [ ] Task 3: Integrate with ResultCard component (AC: 1, 7)
  - [ ] Update ResultCard to use MetadataDisplay
  - [ ] Pass metadata object from generation results
  - [ ] Display metadata only after generation completes
  - [ ] Ensure metadata visible in both active and historical views
- [ ] Task 4: Enhance session persistence (AC: 8)
  - [ ] Store metadata in MongoDB generation_history
  - [ ] Retrieve metadata when loading historical generations
  - [ ] Include metadata in session storage
  - [ ] Persist cost estimates and actuals together
- [ ] Task 5: Create cost summary and reporting (AC: 9, 10)
  - [ ] Create CostSummary component showing total actual cost
  - [ ] Add "Export as CSV/JSON" button including metadata
  - [ ] Generate cost report with breakdown by prompt type and model
  - [ ] Include metadata in clipboard export
  - [ ] Create printable cost report layout
- [ ] Task 6: Backend cost calculation and tracking (AC: 2, 5, 6, 7)
  - [ ] Update GenerationService to return detailed metadata
  - [ ] Calculate actual cost based on token counts from API
  - [ ] Store prompt tokens and completion tokens separately
  - [ ] Return cost breakdown: input cost, output cost, total
  - [ ] Update MongoDB schema for cost tracking
- [ ] Task 7: Write unit and integration tests (AC: all)
  - [ ] Test metadata calculation and display
  - [ ] Test cost comparison logic
  - [ ] Test performance indicator coloring
  - [ ] Test export/reporting functionality
  - [ ] Test metadata persistence and retrieval
  - [ ] Test tooltip rendering with token breakdown

## Dev Notes

### Prerequisites from Previous Stories

[Source: Story 4.3, 4.4, 4.5 - Completion]

Before starting this story, ensure previous stories are complete:
- GenerationContext with generation status and results
- GenerationService with backend cost calculation
- ResultCard component with metadata section
- IterationHistory with result persistence

**Dependencies**:
- Backend returns cost breakdown: {cost, prompt_tokens, completion_tokens, latency}
- ModelContext provides pricing information per model
- Generation results stored with complete metadata in MongoDB

### Project Structure & File Locations

[Source: architecture.md - Source Tree and Module Organization]

**Frontend files to create** in `frontend/src/`:
```
frontend/src/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îî‚îÄ‚îÄ config/
‚îÇ       ‚îú‚îÄ‚îÄ MetadataDisplay.tsx           # Actual metrics display (NEW)
‚îÇ       ‚îú‚îÄ‚îÄ CostComparison.tsx            # Estimated vs actual (NEW)
‚îÇ       ‚îî‚îÄ‚îÄ CostSummary.tsx               # Total cost summary (NEW)
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îî‚îÄ‚îÄ cost-calculator.ts                # Cost calculation utilities (NEW)
‚îî‚îÄ‚îÄ types/
    ‚îî‚îÄ‚îÄ metadata.ts                       # Metadata types (NEW)
```

**Backend files to update** in `backend/app/`:
```
backend/app/
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ generation_service.py             # UPDATED: cost calculation
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îî‚îÄ‚îÄ generation.py                     # UPDATED: metadata schema
‚îî‚îÄ‚îÄ providers/
    ‚îî‚îÄ‚îÄ pricing.py                        # NEW: provider pricing config
```

### Technology Stack Details

[Source: architecture.md - High Level Architecture - Planned Tech Stack]

**Frontend Stack**:
- **React-Bootstrap**: Badge, Tooltip, Alert components for metadata
- **React-Icons**: Icon display for metrics (token, clock, money icons)
- **date-fns**: Format timestamps and durations
- **csv-stringify**: Export functionality for cost reports
- **TypeScript**: Type safety for cost calculations

**Backend Stack**:
- **Python**: Cost calculation based on token counts
- **MongoDB**: Store full metadata with each generation
- **Pricing Configuration**: Per-provider pricing in config

### Metadata Types

[Source: architecture.md - Source Tree and Module Organization - Frontend Module Structure]

**File: frontend/src/types/metadata.ts** (NEW)

Type definitions for metadata:

```typescript
export interface ActualMetrics {
  token_count: number;
  prompt_tokens: number;
  completion_tokens: number;
  latency: number; // in seconds
  cost: number; // in USD
}

export interface EstimatedMetrics {
  estimated_tokens: number;
  estimated_cost: number; // in USD
}

export interface CostBreakdown {
  prompt_cost: number;
  completion_cost: number;
  total_cost: number;
}

export interface GenerationMetadata {
  actual: ActualMetrics;
  estimated: EstimatedMetrics;
  costBreakdown: CostBreakdown;
  variancePercentage: number; // (actual - estimated) / estimated * 100
  timestamp: string;
  model_id: string;
  prompt_type: string;
}
```

### Cost Calculator Utility

[Source: architecture.md - Source Tree and Module Organization - Frontend Module Structure]

**File: frontend/src/lib/cost-calculator.ts** (NEW)

Cost calculation and comparison logic:

```typescript
import { ActualMetrics, EstimatedMetrics, CostBreakdown } from '@/types/metadata';

// Pricing per 1K tokens (as of Oct 2024)
const PRICING_PER_1K_TOKENS = {
  'gpt-4': { input: 0.03, output: 0.06 },
  'gpt-4-turbo': { input: 0.01, output: 0.03 },
  'gpt-3.5-turbo': { input: 0.0005, output: 0.0015 },
  'claude-3-opus': { input: 0.015, output: 0.075 },
  'claude-3-sonnet': { input: 0.003, output: 0.015 },
  'claude-3-haiku': { input: 0.00025, output: 0.00125 },
  'gemini-1.5-pro': { input: 0.00125, output: 0.005 },
  'gemini-1.5-flash': { input: 0.000075, output: 0.0003 }
};

export function calculateActualCost(
  modelId: string,
  promptTokens: number,
  completionTokens: number
): CostBreakdown {
  const pricing = PRICING_PER_1K_TOKENS[modelId as keyof typeof PRICING_PER_1K_TOKENS];

  if (!pricing) {
    console.warn(`No pricing found for model: ${modelId}`);
    return { prompt_cost: 0, completion_cost: 0, total_cost: 0 };
  }

  const promptCost = (promptTokens / 1000) * pricing.input;
  const completionCost = (completionTokens / 1000) * pricing.output;
  const totalCost = promptCost + completionCost;

  return {
    prompt_cost: parseFloat(promptCost.toFixed(6)),
    completion_cost: parseFloat(completionCost.toFixed(6)),
    total_cost: parseFloat(totalCost.toFixed(6))
  };
}

export function estimateCost(
  modelId: string,
  estimatedTokenCount: number,
  ratioOutputToInput: number = 0.5 // Assume 50% of input is output
): number {
  const pricing = PRICING_PER_1K_TOKENS[modelId as keyof typeof PRICING_PER_1K_TOKENS];

  if (!pricing) {
    return 0;
  }

  const inputTokens = Math.ceil(estimatedTokenCount * (1 - ratioOutputToInput));
  const outputTokens = estimatedTokenCount - inputTokens;

  const inputCost = (inputTokens / 1000) * pricing.input;
  const outputCost = (outputTokens / 1000) * pricing.output;

  return parseFloat((inputCost + outputCost).toFixed(6));
}

export function calculateVariance(
  actualCost: number,
  estimatedCost: number
): number {
  if (estimatedCost === 0) return 0;
  return parseFloat((((actualCost - estimatedCost) / estimatedCost) * 100).toFixed(2));
}

export function getPerformanceColor(latencySeconds: number): string {
  if (latencySeconds < 5) return '#28a745'; // green
  if (latencySeconds < 15) return '#ffc107'; // yellow
  return '#dc3545'; // red
}

export function formatCost(cost: number): string {
  return `$${cost.toFixed(4)}`;
}

export function formatDuration(seconds: number): string {
  return `${seconds.toFixed(2)}s`;
}

export function getCostVarianceLabel(variance: number): string {
  if (variance === 0) return 'On estimate';
  if (variance > 0) return `${variance.toFixed(1)}% over`;
  return `${Math.abs(variance).toFixed(1)}% under`;
}
```

### Metadata Display Component

[Source: architecture.md - Source Tree and Module Organization - Frontend Module Structure]

**File: frontend/src/components/config/MetadataDisplay.tsx** (NEW)

Actual metrics display with performance indicators:

```typescript
'use client';

import { Tooltip, OverlayTrigger, Badge } from 'react-bootstrap';
import { GenerationMetadata } from '@/types/metadata';
import {
  getPerformanceColor,
  formatCost,
  formatDuration
} from '@/lib/cost-calculator';

interface MetadataDisplayProps {
  metadata: GenerationMetadata;
  showComparison?: boolean;
}

export default function MetadataDisplay({
  metadata,
  showComparison = true
}: MetadataDisplayProps) {
  const { actual, estimated, costBreakdown, variancePercentage } = metadata;

  const performanceColor = getPerformanceColor(actual.latency);
  const performanceLabel =
    actual.latency < 5
      ? 'FAST'
      : actual.latency < 15
        ? 'MEDIUM'
        : 'SLOW';

  return (
    <div
      className="p-3 rounded mt-3"
      style={{ backgroundColor: '#f8f9fa', fontSize: '0.875rem' }}
    >
      <div className="mb-2">
        <strong>‚ö° ACTUAL METRICS</strong>
      </div>

      {/* Tokens Metric */}
      <div className="d-flex justify-content-between align-items-center mb-2">
        <span>üéØ Tokens: {actual.token_count}</span>
        <OverlayTrigger
          placement="top"
          overlay={
            <Tooltip id={`tooltip-tokens-${metadata.model_id}`}>
              Prompt: {actual.prompt_tokens}, Completion: {actual.completion_tokens}
            </Tooltip>
          }
        >
          <span
            className="text-muted small"
            style={{ cursor: 'help', textDecoration: 'underline' }}
          >
            (breakdown)
          </span>
        </OverlayTrigger>
      </div>

      {/* Latency Metric with Performance Indicator */}
      <div className="d-flex justify-content-between align-items-center mb-2">
        <span>
          ‚è±Ô∏è Time: {formatDuration(actual.latency)}
        </span>
        <Badge
          style={{
            backgroundColor: performanceColor,
            color: 'white'
          }}
        >
          {performanceLabel}
        </Badge>
      </div>

      {/* Cost Metric */}
      <div className="d-flex justify-content-between align-items-center mb-3">
        <span>üí∞ Cost: {formatCost(actual.cost)}</span>
      </div>

      {/* Cost Breakdown (hidden by default, shown on hover) */}
      <OverlayTrigger
        placement="bottom"
        overlay={
          <Tooltip id={`tooltip-cost-${metadata.model_id}`}>
            <div style={{ textAlign: 'left' }}>
              <div>Prompt tokens ({actual.prompt_tokens}): {formatCost(costBreakdown.prompt_cost)}</div>
              <div>Completion tokens ({actual.completion_tokens}): {formatCost(costBreakdown.completion_cost)}</div>
              <div style={{ borderTop: '1px solid rgba(255,255,255,0.3)', paddingTop: '4px', marginTop: '4px' }}>
                <strong>Total: {formatCost(costBreakdown.total_cost)}</strong>
              </div>
            </div>
          </Tooltip>
        }
      >
        <div
          className="text-muted small"
          style={{ cursor: 'help', textDecoration: 'underline' }}
        >
          cost breakdown
        </div>
      </OverlayTrigger>

      {/* Cost Comparison */}
      {showComparison && estimated && (
        <div className="mt-3 pt-3 border-top">
          <div className="d-flex justify-content-between align-items-center">
            <small>
              <strong>Expected:</strong> {formatCost(estimated.estimated_cost)}
            </small>
            <Badge
              bg={
                variancePercentage === 0
                  ? 'secondary'
                  : variancePercentage > 0
                    ? 'warning'
                    : 'success'
              }
            >
              {variancePercentage > 0 ? '+' : ''}{variancePercentage.toFixed(1)}%
            </Badge>
          </div>
        </div>
      )}

      {/* Timestamp */}
      <div className="text-muted text-end mt-2" style={{ fontSize: '0.75rem' }}>
        {new Date(metadata.timestamp).toLocaleTimeString()}
      </div>
    </div>
  );
}
```

### Cost Comparison Component

[Source: architecture.md - Source Tree and Module Organization - Frontend Module Structure]

**File: frontend/src/components/config/CostComparison.tsx** (NEW)

Side-by-side cost comparison:

```typescript
'use client';

import { Card, Row, Col, Badge } from 'react-bootstrap';
import { formatCost, getCostVarianceLabel } from '@/lib/cost-calculator';

interface CostComparisonProps {
  estimatedCost: number;
  actualCost: number;
  modelId: string;
}

export default function CostComparison({
  estimatedCost,
  actualCost,
  modelId
}: CostComparisonProps) {
  const variance = actualCost - estimatedCost;
  const variancePercentage = estimatedCost > 0
    ? (variance / estimatedCost) * 100
    : 0;

  const varianceLabel = getCostVarianceLabel(variancePercentage);

  return (
    <Card className="mt-2 bg-light">
      <Card.Body className="p-2">
        <Row className="g-2">
          <Col md={4}>
            <div className="text-center">
              <div className="text-muted small">Estimated</div>
              <div className="fs-6">
                <strong>{formatCost(estimatedCost)}</strong>
              </div>
            </div>
          </Col>

          <Col md={4} className="text-center">
            <div style={{ paddingTop: '1rem' }}>
              <i className="bi bi-arrow-right"></i>
            </div>
          </Col>

          <Col md={4}>
            <div className="text-center">
              <div className="text-muted small">Actual</div>
              <div className="fs-6">
                <strong>{formatCost(actualCost)}</strong>
              </div>
            </div>
          </Col>
        </Row>

        <div className="text-center mt-2">
          <Badge
            bg={variance > 0 ? 'warning' : variance < 0 ? 'success' : 'secondary'}
          >
            {varianceLabel}
          </Badge>
        </div>
      </Card.Body>
    </Card>
  );
}
```

### Cost Summary Component

[Source: architecture.md - Source Tree and Module Organization - Frontend Module Structure]

**File: frontend/src/components/config/CostSummary.tsx** (NEW)

Total cost summary with export:

```typescript
'use client';

import { useState } from 'react';
import { Card, Button, Badge, Row, Col } from 'react-bootstrap';
import { Download } from 'react-bootstrap-icons';
import { formatCost } from '@/lib/cost-calculator';

interface CostData {
  total: number;
  breakdown: {
    [promptType: string]: {
      [modelId: string]: {
        cost: number;
        tokens: number;
        latency: number;
      };
    };
  };
  generationCount: number;
  timestamp: string;
}

interface CostSummaryProps {
  costData: CostData;
  triggerId: string;
}

export default function CostSummary({ costData, triggerId }: CostSummaryProps) {
  const [exporting, setExporting] = useState(false);

  const handleExportJSON = () => {
    setExporting(true);
    const dataStr = JSON.stringify(costData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `cost-report-${triggerId}-${Date.now()}.json`;
    link.click();
    setExporting(false);
  };

  const handleExportCSV = () => {
    setExporting(true);
    let csv = 'Prompt Type,Model,Cost,Tokens,Latency (s)\n';

    Object.entries(costData.breakdown).forEach(([promptType, models]) => {
      Object.entries(models).forEach(([modelId, data]) => {
        csv += `${promptType},${modelId},${data.cost.toFixed(4)},${data.tokens},${data.latency.toFixed(2)}\n`;
      });
    });

    const dataBlob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `cost-report-${triggerId}-${Date.now()}.csv`;
    link.click();
    setExporting(false);
  };

  return (
    <Card className="mt-4 border-top">
      <Card.Body>
        <Row className="align-items-center mb-3">
          <Col>
            <h6 className="mb-0">
              <strong>üí∞ Total Generation Cost</strong>
            </h6>
          </Col>
          <Col className="text-end">
            <div className="fs-5">
              <strong>{formatCost(costData.total)}</strong>
            </div>
            <small className="text-muted">
              {costData.generationCount} generations
            </small>
          </Col>
        </Row>

        {/* Cost Breakdown by Type */}
        <div className="mt-3 mb-3">
          <strong className="small d-block mb-2">Breakdown by Prompt Type:</strong>
          <Row className="g-2">
            {Object.entries(costData.breakdown).map(([promptType, models]) => {
              const typeCost = Object.values(models).reduce((sum, m) => sum + m.cost, 0);
              return (
                <Col key={promptType} xs={6} md={4}>
                  <div className="p-2 bg-light rounded">
                    <div className="small text-muted">{promptType}</div>
                    <div className="fs-6">
                      <strong>{formatCost(typeCost)}</strong>
                    </div>
                  </div>
                </Col>
              );
            })}
          </Row>
        </div>

        {/* Export Buttons */}
        <div className="d-flex gap-2">
          <Button
            variant="outline-secondary"
            size="sm"
            onClick={handleExportJSON}
            disabled={exporting}
          >
            <Download size={14} className="me-1" />
            Export JSON
          </Button>
          <Button
            variant="outline-secondary"
            size="sm"
            onClick={handleExportCSV}
            disabled={exporting}
          >
            <Download size={14} className="me-1" />
            Export CSV
          </Button>
        </div>

        {/* Report Generated Info */}
        <div className="text-muted small mt-2">
          Report generated {new Date(costData.timestamp).toLocaleString()}
        </div>
      </Card.Body>
    </Card>
  );
}
```

### Backend Cost Calculation Enhancement

[Source: architecture.md - Epic 4 - Multi-Model Generation & Testing]

**File: backend/app/services/generation_service.py** (UPDATED)

Enhanced cost tracking:

```python
# In GenerationService._generate_single method, after successful generation:

def _calculate_cost(
    self,
    model_id: str,
    prompt_tokens: int,
    completion_tokens: int
) -> Dict[str, float]:
    """
    Calculate cost based on actual token counts from API

    Args:
        model_id: Model identifier
        prompt_tokens: Number of prompt tokens
        completion_tokens: Number of completion tokens

    Returns:
        Dict with prompt_cost, completion_cost, total_cost
    """
    pricing = self._get_pricing_for_model(model_id)

    if not pricing:
        return {"prompt_cost": 0.0, "completion_cost": 0.0, "total_cost": 0.0}

    prompt_cost = (prompt_tokens / 1000) * pricing["input"]
    completion_cost = (completion_tokens / 1000) * pricing["output"]
    total_cost = prompt_cost + completion_cost

    return {
        "prompt_cost": round(prompt_cost, 6),
        "completion_cost": round(completion_cost, 6),
        "total_cost": round(total_cost, 6)
    }

def _get_pricing_for_model(self, model_id: str) -> Optional[Dict]:
    """Get pricing configuration for model"""
    pricing_config = {
        "gpt-4": {"input": 0.03, "output": 0.06},
        "gpt-4-turbo": {"input": 0.01, "output": 0.03},
        "gpt-3.5-turbo": {"input": 0.0005, "output": 0.0015},
        "claude-3-opus": {"input": 0.015, "output": 0.075},
        "claude-3-sonnet": {"input": 0.003, "output": 0.015},
        "claude-3-haiku": {"input": 0.00025, "output": 0.00125},
        "gemini-1.5-pro": {"input": 0.00125, "output": 0.005},
        "gemini-1.5-flash": {"input": 0.000075, "output": 0.0003}
    }

    # Try exact match first
    if model_id in pricing_config:
        return pricing_config[model_id]

    # Try partial match
    for key, pricing in pricing_config.items():
        if key in model_id:
            return pricing

    return None
```

### Testing

[Source: PRD - Technical Assumptions - Testing Requirements]

**Unit Tests** (frontend/__tests__/lib/cost-calculator.test.ts):

```typescript
import {
  calculateActualCost,
  estimateCost,
  calculateVariance,
  getPerformanceColor,
  getCostVarianceLabel
} from '@/lib/cost-calculator';

describe('cost-calculator', () => {
  test('calculates actual cost correctly', () => {
    const cost = calculateActualCost('gpt-4', 100, 50);

    // (100/1000 * 0.03) + (50/1000 * 0.06) = 0.003 + 0.003 = 0.006
    expect(cost.total_cost).toBe(0.006);
  });

  test('estimates cost based on token count', () => {
    const estimated = estimateCost('gpt-4', 150);
    expect(estimated).toBeGreaterThan(0);
  });

  test('calculates variance percentage', () => {
    const variance = calculateVariance(0.008, 0.006);
    // (0.008 - 0.006) / 0.006 * 100 = 33.33%
    expect(variance).toBeCloseTo(33.33, 1);
  });

  test('assigns correct performance color', () => {
    expect(getPerformanceColor(3)).toBe('#28a745'); // green
    expect(getPerformanceColor(10)).toBe('#ffc107'); // yellow
    expect(getPerformanceColor(20)).toBe('#dc3545'); // red
  });

  test('generates variance label', () => {
    expect(getCostVarianceLabel(0)).toBe('On estimate');
    expect(getCostVarianceLabel(25)).toMatch(/over/);
    expect(getCostVarianceLabel(-10)).toMatch(/under/);
  });

  test('handles unknown models gracefully', () => {
    const cost = calculateActualCost('unknown-model', 100, 50);
    expect(cost.total_cost).toBe(0);
  });
});
```

**Integration Tests** (frontend/__tests__/components/config/MetadataDisplay.test.tsx):

```typescript
import { render, screen } from '@testing-library/react';
import MetadataDisplay from '@/components/config/MetadataDisplay';
import { GenerationMetadata } from '@/types/metadata';

describe('MetadataDisplay Component', () => {
  const mockMetadata: GenerationMetadata = {
    actual: {
      token_count: 456,
      prompt_tokens: 234,
      completion_tokens: 222,
      latency: 8.3,
      cost: 0.08
    },
    estimated: {
      estimated_tokens: 400,
      estimated_cost: 0.07
    },
    costBreakdown: {
      prompt_cost: 0.007,
      completion_cost: 0.073,
      total_cost: 0.08
    },
    variancePercentage: 14.3,
    timestamp: new Date().toISOString(),
    model_id: 'gpt-4',
    prompt_type: 'paid'
  };

  test('displays actual metrics', () => {
    render(<MetadataDisplay metadata={mockMetadata} />);

    expect(screen.getByText(/üéØ Tokens: 456/)).toBeInTheDocument();
    expect(screen.getByText(/‚è±Ô∏è Time: 8.30s/)).toBeInTheDocument();
    expect(screen.getByText(/üí∞ Cost: \$0.0800/)).toBeInTheDocument();
  });

  test('shows performance indicator badge', () => {
    render(<MetadataDisplay metadata={mockMetadata} />);

    expect(screen.getByText('MEDIUM')).toBeInTheDocument();
  });

  test('displays cost comparison when enabled', () => {
    render(<MetadataDisplay metadata={mockMetadata} showComparison={true} />);

    expect(screen.getByText(/Expected:/)).toBeInTheDocument();
    expect(screen.getByText(/14.3%/)).toBeInTheDocument();
  });

  test('displays token breakdown on tooltip', () => {
    render(<MetadataDisplay metadata={mockMetadata} />);

    const breakdownLink = screen.getByText('(breakdown)');
    expect(breakdownLink).toBeInTheDocument();
  });
});
```

**Manual Verification Checklist**:
1. Metadata section appears below each result card after generation completes
2. Three metrics displayed: Tokens (üéØ), Time (‚è±Ô∏è), Cost (üí∞)
3. Metadata container has #f8f9fa background color
4. "‚ö° ACTUAL METRICS" label visible
5. Performance indicator badge shows correct color (green/yellow/red)
6. Token breakdown tooltip displays prompt and completion tokens
7. Cost comparison shows estimated vs. actual side-by-side
8. Variance percentage displayed with color coding
9. Cost metrics persist when viewing historical generations
10. Total cost summary calculates and displays correctly
11. Export JSON downloads cost report with full metadata
12. Export CSV formats data correctly for spreadsheet
13. Timestamp displayed for each metadata set
14. Responsive design on mobile/tablet (metadata stacked appropriately)
15. No console errors or warnings

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-29 | 1.0 | Initial story created from Epic 4 | Sarah (PO) |
| 2025-10-29 | 1.1 | Complete implementation with MetadataDisplay, cost calculation, and reporting | Dev Agent |

## Dev Agent Record

*To be populated during implementation*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes List

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*To be filled by QA agent*
